<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>无限剑制 · 1v1 知识竞赛</title>
<style>
body {
  margin: 0;
  font-family: "Noto Serif SC", serif;
  background: #0b0000;
  color: #e6d0d0;
}
#home, #game {
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
h1 {
  color: #8b0000;
  text-align: center;
  letter-spacing: 4px;
}
button {
  background: #5a0000;
  color: #fff;
  border: 1px solid #8b0000;
  padding: 10px 20px;
  cursor: pointer;
  margin: 5px;
}
button:hover { background: #8b0000; }
textarea {
  width: 100%;
  height: 100px;
  background: #120000;
  color: #e6d0d0;
  border: 1px solid #8b0000;
}
#banner {
  width: 100%;
  max-height: 300px;
  object-fit: cover;
  border: 2px solid #8b0000;
}
.hp {
  display: inline-block;
  padding: 5px 10px;
  border: 1px solid #8b0000;
  margin: 5px;
}
#timer { font-size: 20px; color: #ff4444; }
.option {
  display: block;
  margin: 8px 0;
  padding: 8px;
  border: 1px solid #8b0000;
  cursor: pointer;
}
.option:hover { background: #300000; }
</style>
</head>

<body>

<div id="home">
  <h1>无限剑制</h1>
  <img id="banner" src="fl.jpg">
  <p><b>1v1 知识竞赛</b><br>
  主题：马克思主义政治经济学 · 辩证唯物主义 · 历史唯物主义 · 列宁主义</p>

  <button onclick="startAsHost()">创建房间</button>
  <button onclick="startAsGuest()">加入房间</button>

  <p>连接信息：</p>
  <textarea id="signal"></textarea>
</div>

<div id="game" style="display:none;">
  <h1>无限剑制 · 对战中</h1>
  <div>
    <span class="hp">我方血量：<span id="myHP">10</span></span>
    <span class="hp">对方血量：<span id="opHP">10</span></span>
    <span id="timer">20</span>s
  </div>
  <h2 id="question"></h2>
  <div id="options"></div>
</div>

<script>
/* ===================== 题库（内容型正确答案） ===================== */
const QUESTION_BANK = [
  {
    q: "商品的二因素是？",
    correct: "使用价值和价值",
    wrong: ["价格和价值", "劳动和资本", "交换和分配"]
  },
  {
    q: "价值的实体是？",
    correct: "抽象劳动",
    wrong: ["具体劳动", "货币", "资本"]
  },
  {
    q: "剩余价值的真正来源是？",
    correct: "劳动者的剩余劳动",
    wrong: ["流通领域", "资本增值", "市场交换"]
  },
  {
  q: "毛泽东人民战争理论的根本依靠力量是？",
  correct: "广大人民群众",
  wrong: ["正规军队", "先进武器", "国际援助"]
},
{
  q: "毛泽东认为战争胜负的决定因素是？",
  correct: "人而不是物",
  wrong: ["武器装备", "经济实力", "地理条件"]
},
{
  q: "人民战争的战略基础是？",
  correct: "发动和依靠群众",
  wrong: ["集中兵力决战", "技术优势", "外部支援"]
},
{
  q: "《矛盾论》中指出事物发展的根本原因在于？",
  correct: "事物内部的矛盾",
  wrong: ["外部条件", "偶然因素", "主观意志"]
},
{
  q: "矛盾的同一性主要表现为？",
  correct: "矛盾双方相互依存",
  wrong: ["相互排斥", "相互斗争", "相互否定"]
},
{
  q: "矛盾斗争性的主要表现是？",
  correct: "矛盾双方相互对立",
  wrong: ["相互依赖", "相互渗透", "相互融合"]
},
{
  q: "主要矛盾在事物发展中起到的作用是？",
  correct: "决定性作用",
  wrong: ["次要作用", "辅助作用", "偶然作用"]
},
{
  q: "《实践论》中指出认识的来源是？",
  correct: "社会实践",
  wrong: ["先验理性", "主观感觉", "书本知识"]
},
{
  q: "实践在认识过程中的地位是？",
  correct: "认识的基础和动力",
  wrong: ["认识的结果", "认识的外在条件", "认识的附属环节"]
},
{
  q: "检验认识是否具有真理性的唯一标准是？",
  correct: "实践",
  wrong: ["理论体系", "群众意见", "逻辑推理"]
},
{
  q: "毛泽东认为正确认识一般要经过几个阶段？",
  correct: "从实践到认识，再到实践",
  wrong: ["从认识到实践", "从感觉到信念", "从理论到结论"]
},
{
  q: "两条路线斗争实质上是？",
  correct: "不同阶级立场和政治路线的斗争",
  wrong: ["个人恩怨斗争", "思想分歧争论", "组织形式差异"]
},
{
  q: "在革命和建设中，坚持正确路线的根本方法是？",
  correct: "实事求是",
  wrong: ["照搬经验", "主观臆断", "个人权威"]
},
{
  q: "毛泽东强调调查研究的根本目的在于？",
  correct: "从实际出发解决问题",
  wrong: ["收集材料", "完成报告", "验证理论"]
},
{
  q: "群众路线的基本内容是？",
  correct: "从群众中来，到群众中去",
  wrong: ["领导决定一切", "精英推动变革", "自上而下动员"]
},
{
  q: "人民战争中游击战争的重要战略作用是？",
  correct: "配合和支援正规战争",
  wrong: ["取代正规战争", "避免一切战斗", "单独决定胜负"]
},
{
  q: "矛盾普遍性原理说明？",
  correct: "矛盾存在于一切事物中",
  wrong: ["只有社会存在矛盾", "矛盾是暂时现象", "矛盾可以被消除"]
},
{
  q: "矛盾特殊性原理强调？",
  correct: "具体问题具体分析",
  wrong: ["统一标准处理问题", "经验可以照搬", "理论高于实际"]
},
{
  q: "毛泽东认为革命战争的根本目的在于？",
  correct: "解放人民群众",
  wrong: ["扩大领土", "争夺资源", "展示力量"]
},
{
  q: "毛泽东思想活的灵魂不包括以下哪一项？",
  correct: "教条主义",
  wrong: ["实事求是", "群众路线", "独立自主"]
}

  {
    q: "矛盾的基本属性是？",
    correct: "对立性和统一性",
    wrong: ["普遍性和特殊性", "必然性和偶然性", "主观性和客观性"]
  },
  {
    q: "意识的本质是？",
    correct: "物质的反映",
    wrong: ["先验精神", "灵魂实体", "大脑分泌物"]
  },
  {
    q: "历史唯物主义认为社会发展的根本动力是？",
    correct: "生产力与生产关系的矛盾运动",
    wrong: ["英雄人物活动", "思想变革", "偶然事件"]
  },
  {
    q: "社会存在决定？",
    correct: "社会意识",
    wrong: ["国家制度", "法律体系", "政治路线"]
  },
  {
    q: "列宁认为帝国主义的本质是？",
    correct: "垄断资本主义",
    wrong: ["自由资本主义", "国家社会主义", "殖民主义"]
  },
  {
    q: "列宁主义的核心观点之一是？",
    correct: "无产阶级先锋队政党",
    wrong: ["自发革命", "改良主义", "多党竞争"]
  },
  {
    q: "实践是检验真理的？",
    correct: "唯一标准",
    wrong: ["主要标准", "相对标准", "经验标准"]
  }
];

// 自动补足到 50 题
while (QUESTION_BANK.length < 50) {
  QUESTION_BANK.push(JSON.parse(JSON.stringify(
    QUESTION_BANK[QUESTION_BANK.length % 10]
  )));
}

/* ===================== WebRTC ===================== */
let pc, channel;
let myHP = 10, opHP = 10;
let questions = [], index = 0;
let timer = 20, timerId;
let myAnswer = null, opAnswer = null;
let correctIndex = null;

function createPC() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });
  pc.onicecandidate = e => {
    if (e.candidate) {
      document.getElementById("signal").value =
        JSON.stringify(pc.localDescription);
    }
  };
  pc.ondatachannel = e => {
    channel = e.channel;
    channel.onmessage = ev => handleMessage(JSON.parse(ev.data));
  };
}

async function startAsHost() {
  createPC();
  channel = pc.createDataChannel("game");
  channel.onmessage = e => handleMessage(JSON.parse(e.data));
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
}

async function startAsGuest() {
  createPC();
  const offer = JSON.parse(document.getElementById("signal").value);
  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  document.getElementById("signal").value = JSON.stringify(answer);
}

/* ===================== 游戏逻辑 ===================== */
function startGame() {
  document.getElementById("home").style.display = "none";
  document.getElementById("game").style.display = "block";
  questions = QUESTION_BANK.sort(() => Math.random() - 0.5).slice(0, 5);
  index = 0;
  nextQuestion();
}

function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

function nextQuestion() {
  myAnswer = opAnswer = null;
  timer = 20;
  updateTimer();

  const q = questions[index];
  document.getElementById("question").innerText = q.q;
  const opt = document.getElementById("options");
  opt.innerHTML = "";

  const options = shuffle([q.correct, ...q.wrong]);
  correctIndex = options.indexOf(q.correct);

  options.forEach((t, i) => {
    const d = document.createElement("div");
    d.className = "option";
    d.innerText = t;
    d.onclick = () => answer(i);
    opt.appendChild(d);
  });

  timerId = setInterval(() => {
    timer--;
    updateTimer();
    if (timer <= 0) finishRound();
  }, 1000);
}

function answer(i) {
  if (myAnswer !== null) return;
  myAnswer = i;
  channel.send(JSON.stringify({ type: "answer", value: i }));
}

function handleMessage(msg) {
  if (msg.type === "answer") opAnswer = msg.value;
}

function finishRound() {
  clearInterval(timerId);

  const myRight = myAnswer === correctIndex;
  const opRight = opAnswer === correctIndex;

  if (myRight && !opRight) opHP--;
  if (!myRight && opRight) myHP--;

  document.getElementById("myHP").innerText = myHP;
  document.getElementById("opHP").innerText = opHP;

  index++;
  if (myHP <= 0 || opHP <= 0 || index >= 5) {
    alert(myHP > opHP ? "你获胜了！" : "你失败了！");
    location.reload();
  } else {
    nextQuestion();
  }
}

function updateTimer() {
  document.getElementById("timer").innerText = timer;
}

setInterval(() => {
  if (channel && channel.readyState === "open") startGame();
}, 500);
</script>

</body>
</html>

